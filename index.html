<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- <script type="text/javascript" src="https://cdn.jsdelivr.net/pyodide/v0.28.2/full/pyodide.js"></script> -->
  <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-3.8.1.js"></script>
  <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-widgets-3.8.1.min.js"></script>
  <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-tables-3.8.1.min.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@holoviz/panel@1.8.3/dist/panel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>

  <title>Panel + Pyodide App</title>
  <link rel="stylesheet" href="static/styles.css" />
</head>

<body>
  <!-- Loading splash (visible while Pyodide / wheels download) -->
  <div id="loading">
    <div>
      ⏳ Loading Python runtime and Panel…<br />
      <small id="loading-detail">Initializing</small>
    </div>
  </div>

  <!-- Panel will render into this -->
  <div class="app-grid" role="application">
    <div id="sidebar" aria-label="Sidebar placeholder">
      <!-- Panel will mount here -->
    </div>

    <header id="topbar">
      <h3 style="margin:0;">My Dashboard</h3>
    </header>

    <main id="main" role="main">
      <!-- Panel will mount main content here -->
    </main>

    <footer id="footer">
      © H. Leitte 2025 — <a href="https://github.com/YOUR_REPO" target="_blank">GitHub repo</a>
    </footer>
  </div>

  <script>
    window.ort_helpers = (function () {
      let session = null;

      async function tryCreate(source, provider) {
        try {
          console.log(`[ort] trying provider=${provider}, sourceType=${Object.prototype.toString.call(source)}`);
          const opts = { executionProviders: [provider] };
          const s = await ort.InferenceSession.create(source, opts);
          console.log(`[ort] created session with ${provider}`);
          return s;
        } catch (err) {
          console.warn(`[ort] provider ${provider} failed:`, err && err.message ? err.message : err);
          return null;
        }
      }

      // Public createSession: accepts URL string, Uint8Array, or ArrayBuffer
      async function createSession(modelSource) {
        const providers = ['webgpu', 'wasm']; // try in preference order

        // If user passed a Uint8Array, also try its .buffer (ArrayBuffer)
        const sources = [];
        if (modelSource instanceof Uint8Array) {
          sources.push(modelSource);
          if (modelSource.buffer) sources.push(modelSource.buffer);
        } else {
          sources.push(modelSource);
        }

        for (const provider of providers) {
          for (const src of sources) {
            const s = await tryCreate(src, provider);
            if (s) {
              session = s;
              // Safely collect input/output names if available (some builds may not populate .inputs until later)
              try {
                session.inputNames = (session.inputs && session.inputs.map(i => i.name)) || session.inputNames || [];
                session.outputNames = (session.outputs && session.outputs.map(o => o.name)) || session.outputNames || [];
              } catch (e) {
                console.warn('[ort] could not collect input/output names safely', e);
              }
              return { backend: provider, inputNames: session.inputNames, outputNames: session.outputNames };
            }
          }
        }
        throw new Error('No ONNX backend available (checked webgpu and wasm)');
      }

      async function runModel(tensorData, shape, inputName = null) {
        if (!session) throw new Error('Session not initialized');
        const inName = inputName || (session.inputNames && session.inputNames[0]) || (session.inputs && session.inputs[0] && session.inputs[0].name);
        if (!inName) throw new Error('Cannot determine model input name');
        const tensor = new ort.Tensor('float32', tensorData, shape);
        const feeds = {}; feeds[inName] = tensor;
        const t0 = performance.now();
        const outs = await session.run(feeds);
        const t1 = performance.now();
        const outName = Object.keys(outs)[0];
        return { data: outs[outName].data, dims: outs[outName].dims, ms: (t1 - t0) };
      }

      return { createSession, runModel };
    })();
  </script>


  <script type="module">
    import { loadPyodide } from "/static/pyodide/pyodide.mjs";
    
    async function boot() {
      const ld = document.getElementById("loading-detail");
      try {
        ld.innerText = "Loading Pyodide (WebAssembly)…";
        // const pyodide = await loadPyodide();
        const pyodide = await loadPyodide({ indexURL: "/static/pyodide/" });

        ld.innerText = "Installing micropip & Panel/Bokeh wheels…";
        // load micropip then install the Panel/Bokeh wheels (versions must match the HTML above)
        await pyodide.loadPackage("micropip");
        const micropip = pyodide.pyimport("micropip");

        // Install holoviz wheels (these are the smaller prebuilt wheels recommended for web)
        await micropip.install([
          "https://cdn.holoviz.org/panel/wheels/bokeh-3.8.1-py3-none-any.whl",
          "https://cdn.holoviz.org/panel/wheels/panel-1.8.3-py3-none-any.whl",
          "holoviews==1.21.0"
        ]);

        // load and mount additional python files
        // create zip with: 
        // cd src && zip -r ../static/src.zip * && cd ..
        const resp_code = await fetch("./static/src.zip");
        const buf = await resp_code.arrayBuffer();
        pyodide.unpackArchive(buf, "zip", { extractDir: "/src" });

        ld.innerText = "Fetching and starting the app…";
        const resp = await fetch("main.py");
        if (!resp.ok) throw new Error("Failed to fetch main.py: " + resp.status);
        const code = await resp.text();
        await pyodide.runPythonAsync(code);

        // hide the loading splash — the app should be visible now
        document.getElementById("loading").style.display = "none";
      } catch (err) {
        console.error("Boot failed:", err);
        document.getElementById("loading-detail").innerText = "Failed to start (see console)";
      }
    }

    boot();
  </script>
</body>

</html>